<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Libomi - Gestión</title>
    <style>
        /* Reset básico */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logo {
            max-width: 150px;
            max-height: 80px;
            object-fit: contain;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .header-title {
            flex: 1;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .logo-controls {
            display: flex;
            gap: 0.5rem;
        }

        .url-info {
            background: rgba(255,255,255,0.15);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            word-break: break-all;
        }

        /* Navegación */
        .nav {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 0.5rem 0;
            border-bottom: 1px solid #e0e6ed;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            color: #64748b;
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .tab:hover:not(.active) {
            background: #f1f5f9;
        }

        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Secciones */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card h3 {
            margin-bottom: 1rem;
            color: #1e293b;
        }

        /* Cloud storage status */
        .cloud-status {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cloud-status.connected {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        .cloud-status.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        /* Image URL configurator */
        .github-config {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .github-config label {
            font-weight: 500;
            color: #374151;
            display: block;
            margin-bottom: 0.5rem;
        }

        .github-config input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .github-config .example {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
            font-family: monospace;
        }

        /* Formulario */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* Vista previa de imagen */
        .image-preview {
            width: 200px;
            height: 200px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            overflow: hidden;
            background: #f9fafb;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview.empty {
            color: #6b7280;
            font-size: 0.875rem;
            text-align: center;
            padding: 1rem;
        }

        /* Grid de productos */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .product-image:hover img {
            transform: scale(1.05);
        }

        .product-info {
            padding: 1rem;
        }

        .product-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1e293b;
        }

        .product-meta {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .product-description {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0 1rem 1rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #f59e0b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .url-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <img id="logoImage" class="logo" src="https://raw.githubusercontent.com/lucre0191-ai/catalogo-mejorado/main/images/logo.png" alt="Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect width=\'100%25\' height=\'100%25\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%239ca3af\' font-size=\'10\'%3ESin Logo%3C/text%3E%3C/svg%3E'">
            <h1 class="header-title">Catálogo de Productos - Libomi</h1>
            <div class="url-info" id="urlDisplay">
                🌐 <span id="currentUrl"></span>
            </div>
        </div>
    </header>

    <!-- Navegación -->
    <nav class="nav">
        <div class="nav-content">
            <button class="tab active" onclick="showSection('productos')">Entrada de Datos</button>
            <button class="tab" onclick="showSection('catalogo')">Ver Catálogo</button>
            <button class="tab" onclick="showSection('categorias')">Categorías</button>
            <button class="tab" onclick="showSection('almacenes')">Almacenes</button>
            <button class="tab" onclick="showSection('configuracion')">Configuración</button>
            <button class="tab" onclick="showSection('respaldo')">Sincronización</button>
        </div>
    </nav>

    <!-- Contenido principal -->
    <main class="container">
        <!-- Sección: Productos -->
        <section id="productos" class="section active">
            <div class="cloud-status" id="cloudStatus">
                <span>📊</span>
                <span id="cloudStatusText">Estado de sincronización</span>
                <button class="btn btn-outline" onclick="syncData()" style="margin-left: auto; padding: 0.25rem 0.75rem;">
                    Sincronizar
                </button>
            </div>

            <div class="card">
                <h3>Agregar / Editar Producto</h3>
                <form id="productForm" class="form-grid">
                    <div>
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="productName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Código</label>
                            <input type="text" id="productCode" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Almacén *</label>
                            <select id="productWarehouse" class="form-control" required></select>
                        </div>
                        <div class="form-group">
                            <label>Categoría *</label>
                            <select id="productCategory" class="form-control" required></select>
                        </div>
                        <div class="form-group">
                            <label>Subcategoría</label>
                            <select id="productSubcategory" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Descripción</label>
                            <textarea id="productDescription" class="form-control" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Guardar Producto</button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">Limpiar</button>
                            <button type="button" class="btn btn-danger" onclick="deleteCurrentProduct()">Eliminar</button>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Imagen (usar URL de GitHub)</label>
                            <input type="url" id="productImageUrl" class="form-control" placeholder="https://raw.githubusercontent.com/usuario/repo/main/images/producto.jpg">
                            <small style="color: #666; font-size: 0.8rem; margin-top: 0.25rem; display: block;">
                                Sube tu imagen a GitHub y pega aquí la URL raw
                            </small>
                        </div>
                        <div class="form-group">
                            <div id="imagePreview" class="image-preview empty">
                                <span>Ingresa una URL de imagen</span>
                            </div>
                            <button type="button" class="btn btn-outline" onclick="previewImageFromUrl()">
                                Ver Vista Previa
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <h3>Lista de Productos</h3>
                <div id="productsList" class="products-grid"></div>
            </div>
        </section>

        <!-- Sección: Catálogo -->
        <section id="catalogo" class="section">
            <div class="card">
                <h3>Catálogo de Productos</h3>
                <div id="catalogContent"></div>
            </div>
        </section>

        <!-- Sección: Categorías -->
        <section id="categorias" class="section">
            <div class="card">
                <h3>Gestión de Categorías</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <input type="text" id="newCategoryName" class="form-control" placeholder="Nueva categoría">
                    <input type="text" id="newSubcategoryName" class="form-control" placeholder="Nueva subcategoría">
                    <button class="btn btn-primary" onclick="addCategory()">Agregar</button>
                </div>
                <div id="categoriesList"></div>
            </div>
        </section>

        <!-- Sección: Almacenes -->
        <section id="almacenes" class="section">
            <div class="card">
                <h3>Gestión de Almacenes</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <input type="text" id="newWarehouseName" class="form-control" placeholder="Nuevo almacén">
                    <button class="btn btn-primary" onclick="addWarehouse()">Agregar</button>
                </div>
                <div id="warehousesList"></div>
            </div>
        </section>

        <!-- Sección: Configuración -->
        <section id="configuracion" class="section">
            <div class="card">
                <h3>Configuración de GitHub</h3>
                <div class="github-config">
                    <label>URL base para imágenes:</label>
                    <input type="url" id="githubBaseUrl" class="form-control" 
                           value="https://raw.githubusercontent.com/lucre0191-ai/catalogo-mejorado/main/images/"
                           placeholder="https://raw.githubusercontent.com/usuario/repo/main/images/">
                    <div class="example">
                        Ejemplo: Si subes "producto1.jpg" a GitHub, la URL completa será:<br>
                        <span id="exampleUrl">https://raw.githubusercontent.com/usuario/repo/main/images/producto1.jpg</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveConfig()">Guardar Configuración</button>
            </div>

            <div class="card">
                <h3>Configuración de Sincronización</h3>
                <p style="color: #666; margin-bottom: 1rem;">
                    Para mantener tus datos sincronizados entre diferentes ordenadores, puedes usar:
                </p>
                <div style="display: grid; gap: 1rem;">
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h4 style="color: #1e293b; margin-bottom: 0.5rem;">📱 Método Manual (Recomendado)</h4>
                        <p style="color: #64748b; font-size: 0.875rem;">
                            Usa la función "Exportar/Importar" en la pestaña Sincronización para copiar/pegar tus datos entre ordenadores.
                        </p>
                    </div>
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border: 1px solid #fbbf24;">
                        <h4 style="color: #92400e; margin-bottom: 0.5rem;">☁️ Método Automático (Avanzado)</h4>
                        <p style="color: #92400e; font-size: 0.875rem;">
                            Configura un servicio de almacenamiento en la nube como Firebase, Supabase o similar.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección: Sincronización -->
        <section id="respaldo" class="section">
            <div class="card">
                <h3>Exportar / Importar Datos</h3>
                <p style="color: #666; margin-bottom: 1rem;">
                    Usa estas funciones para mantener tus datos sincronizados entre diferentes ordenadores.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <label><strong>📤 Exportar datos (copiar):</strong></label>
                        <textarea id="exportData" class="form-control" rows="10" readonly placeholder="Haz clic en 'Generar Exportación' para ver los datos aquí"></textarea>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="exportData()">Generar Exportación</button>
                            <button class="btn btn-outline" onclick="copyToClipboard('exportData')">Copiar al Portapapeles</button>
                        </div>
                    </div>
                    <div>
                        <label><strong>📥 Importar datos (pegar):</strong></label>
                        <textarea id="importData" class="form-control" rows="10" placeholder="Pega aquí los datos exportados desde otro ordenador"></textarea>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="importData()">Importar Datos</button>
                            <button class="btn btn-outline" onclick="pasteFromClipboard('importData')">Pegar del Portapapeles</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 2rem; text-align: center; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                    <button class="btn btn-danger" onclick="resetAllData()">🗑️ Borrar Todos los Datos</button>
                </div>
            </div>

            <!-- Instrucciones mejoradas -->
            <div class="card" style="background:#f0f9ff; border:1px solid #38bdf8">
                <h3 style="color:#0369a1">🔄 Cómo sincronizar entre ordenadores</h3>
                <div style="color:#0c4a6e; line-height:1.6">
                    <ol style="padding-left: 1.5rem;">
                        <li><strong>En el ordenador A:</strong> Ve a "Sincronización" → "Generar Exportación" → Copia los datos</li>
                        <li><strong>Comparte los datos:</strong> Email, WhatsApp, USB, etc.</li>
                        <li><strong>En el ordenador B:</strong> Ve a "Sincronización" → Pega los datos → "Importar Datos"</li>
                        <li><strong>¡Listo!</strong> Todos tus productos, categorías y almacenes estarán disponibles</li>
                    </ol>
                    <div style="margin-top:12px; padding:12px; background:rgba(59,130,246,0.1); border-radius:6px">
                        💡 <strong>Tip:</strong> Exporta tus datos regularmente como respaldo
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Variables globales
        let products = JSON.parse(localStorage.getItem('libomi_products_v3') || '[]');
        let categories = JSON.parse(localStorage.getItem('libomi_categories_v3') || '{"General": ["Varios"]}');
        let warehouses = JSON.parse(localStorage.getItem('libomi_warehouses_v3') || '["Almacén Principal"]');
        let config = JSON.parse(localStorage.getItem('libomi_config_v3') || '{}');
        let currentEditId = null;

        // Placeholder para imágenes
        const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="16" font-family="Arial">Sin imagen</text></svg>`
        );

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            updateUrlDisplay();
            renderWarehouses();
            renderCategories();
            renderProducts();
            renderCatalog();
            loadConfig();
            updateCloudStatus();
            
            // Event listeners
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('productCategory').addEventListener('change', loadSubcategories);
            document.getElementById('githubBaseUrl').addEventListener('input', updateExampleUrl);
        });

        // Funciones de utilidad
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : ''}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function updateUrlDisplay() {
            const urlElement = document.getElementById('currentUrl');
            if (urlElement) {
                urlElement.textContent = window.location.href;
            }
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionName === 'catalogo') {
                renderCatalog();
            } else if (sectionName === 'categorias') {
                renderCategoryLists();
            } else if (sectionName === 'almacenes') {
                renderWarehouseList();
            }
        }

        function generateId() {
            return 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveData() {
            try {
                localStorage.setItem('libomi_products_v3', JSON.stringify(products));
                localStorage.setItem('libomi_categories_v3', JSON.stringify(categories));
                localStorage.setItem('libomi_warehouses_v3', JSON.stringify(warehouses));
                localStorage.setItem('libomi_config_v3', JSON.stringify(config));
                updateCloudStatus();
            } catch (e) {
                console.error('Error guardando en localStorage', e);
                showToast('No se pudo guardar localmente', 'error');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Funciones de configuración
        function loadConfig() {
            const githubBaseUrl = document.getElementById('githubBaseUrl');
            if (config.githubBaseUrl) {
                githubBaseUrl.value = config.githubBaseUrl;
            }
            updateExampleUrl();
        }

        function saveConfig() {
            config.githubBaseUrl = document.getElementById('githubBaseUrl').value;
            localStorage.setItem('libomi_config_v3', JSON.stringify(config));
            showToast('Configuración guardada');
            updateExampleUrl();
        }

        function updateExampleUrl() {
            const baseUrl = document.getElementById('githubBaseUrl').value;
            const exampleUrl = document.getElementById('exampleUrl');
            if (baseUrl && exampleUrl) {
                exampleUrl.textContent = baseUrl + 'producto1.jpg';
            }
        }

        // Funciones de imagen
        function previewImageFromUrl() {
            const url = document.getElementById('productImageUrl').value.trim();
            const preview = document.getElementById('imagePreview');
            
            if (!url) {
                preview.innerHTML = '<span>Ingresa una URL de imagen</span>';
                preview.classList.add('empty');
                return;
            }

            // Mostrar loading
            preview.innerHTML = '<span>Cargando imagen...</span>';
            preview.classList.add('empty');

            // Crear imagen para probar si carga
            const img = new Image();
            img.onload = function() {
                preview.innerHTML = `<img src="${url}" alt="Vista previa">`;
                preview.classList.remove('empty');
                showToast('Imagen cargada correctamente');
            };
            img.onerror = function() {
                preview.innerHTML = '<span style="color: #dc2626;">Error: No se pudo cargar la imagen</span>';
                preview.classList.add('empty');
                showToast('No se pudo cargar la imagen. Verifica la URL', 'error');
            };
            img.src = url;
        }

        // Funciones de cloud status
        function updateCloudStatus() {
            const status = document.getElementById('cloudStatus');
            const statusText = document.getElementById('cloudStatusText');
            
            const totalItems = products.length + Object.keys(categories).length + warehouses.length;
            const lastSync = localStorage.getItem('libomi_last_sync');
            
            if (lastSync) {
                const syncDate = new Date(lastSync);
                statusText.textContent = `Última sincronización: ${syncDate.toLocaleString()} (${totalItems} elementos)`;
                status.className = 'cloud-status connected';
            } else {
                statusText.textContent = `${totalItems} elementos guardados localmente - Sin sincronizar`;
                status.className = 'cloud-status';
            }
        }

        function syncData() {
            // Simular sincronización (en una implementación real, aquí conectarías con tu API)
            localStorage.setItem('libomi_last_sync', new Date().toISOString());
            updateCloudStatus();
            showToast('Datos sincronizados localmente');
        }

        // Funciones de almacenes
        function renderWarehouses() {
            const warehouseSelect = document.getElementById('productWarehouse');
            
            warehouseSelect.innerHTML = '<option value="">Seleccionar almacén...</option>';
            
            warehouses.forEach(warehouse => {
                const option = new Option(warehouse, warehouse);
                warehouseSelect.add(option);
            });
        }

        function renderWarehouseList() {
            const warehousesList = document.getElementById('warehousesList');
            
            let warehousesHtml = '';
            warehouses.forEach(warehouse => {
                warehousesHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;">
                        <span><strong>${escapeHtml(warehouse)}</strong></span>
                        <button class="btn btn-danger" onclick="deleteWarehouse('${escapeHtml(warehouse)}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                            Eliminar
                        </button>
                    </div>
                `;
            });
            warehousesList.innerHTML = warehousesHtml || '<p>No hay almacenes registrados.</p>';
        }

        function addWarehouse() {
            const warehouseName = document.getElementById('newWarehouseName').value.trim();
            
            if (!warehouseName) {
                showToast('Ingresa el nombre del almacén', 'error');
                return;
            }
            
            if (warehouses.includes(warehouseName)) {
                showToast('Este almacén ya existe', 'warning');
                return;
            }
            
            warehouses.push(warehouseName);
            saveData();
            renderWarehouses();
            renderWarehouseList();
            document.getElementById('newWarehouseName').value = '';
            showToast('Almacén agregado exitosamente');
        }

        function deleteWarehouse(warehouseName) {
            if (confirm(`¿Eliminar el almacén "${warehouseName}"?`)) {
                warehouses = warehouses.filter(w => w !== warehouseName);
                products.forEach(product => {
                    if (product.warehouse === warehouseName) {
                        product.warehouse = '';
                    }
                });
                saveData();
                renderWarehouses();
                renderWarehouseList();
                renderProducts();
                showToast('Almacén eliminado', 'warning');
            }
        }

        // Funciones de categorías
        function renderCategories() {
            const categorySelect = document.getElementById('productCategory');
            
            categorySelect.innerHTML = '<option value="">Seleccionar categoría...</option>';
            
            Object.keys(categories).forEach(cat => {
                const option = new Option(cat, cat);
                categorySelect.add(option);
            });
            
            if (Object.keys(categories).length > 0) {
                loadSubcategories();
            }
        }

        function loadSubcategories() {
            const categorySelect = document.getElementById('productCategory');
            const subcategorySelect = document.getElementById('productSubcategory');
            const selectedCategory = categorySelect.value;
            
            subcategorySelect.innerHTML = '<option value="">Sin subcategoría</option>';
            
            if (selectedCategory && categories[selectedCategory]) {
                categories[selectedCategory].forEach(sub => {
                    subcategorySelect.add(new Option(sub, sub));
                });
            }
        }

        function renderCategoryLists() {
            const categoriesList = document.getElementById('categoriesList');
            
            let categoriesHtml = '<h4 style="margin-bottom: 1rem;">Categorías Existentes</h4>';
            Object.keys(categories).forEach(cat => {
                categoriesHtml += `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <span><strong>${escapeHtml(cat)}</strong></span>
                            <button class="btn btn-danger" onclick="deleteCategory('${escapeHtml(cat)}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                Eliminar
                            </button>
                        </div>
                `;
                
                if (categories[cat] && categories[cat].length > 0) {
                    categoriesHtml += '<div style="margin-left: 1rem; margin-top: 0.5rem;">';
                    categories[cat].forEach(sub => {
                        categoriesHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8fafc; border-radius: 6px; margin-bottom: 0.25rem; border: 1px solid #e2e8f0;">
                                <span>${escapeHtml(sub)}</span>
                                <button class="btn btn-danger" onclick="deleteSubcategory('${escapeHtml(cat)}', '${escapeHtml(sub)}')" style="padding: 0.125rem 0.25rem; font-size: 0.625rem;">
                                    ×
                                </button>
                            </div>
                        `;
                    });
                    categoriesHtml += '</div>';
                }
                
                categoriesHtml += '</div>';
            });
            
            categoriesList.innerHTML = categoriesHtml;
        }

        function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            const subcategoryName = document.getElementById('newSubcategoryName').value.trim();
            
            if (!categoryName) {
                showToast('Ingresa el nombre de la categoría', 'error');
                return;
            }
            
            if (!categories[categoryName]) {
                categories[categoryName] = [];
            }
            
            if (subcategoryName && !categories[categoryName].includes(subcategoryName)) {
                categories[categoryName].push(subcategoryName);
            }
            
            saveData();
            renderCategories();
            renderCategoryLists();
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newSubcategoryName').value = '';
            showToast('Categoría agregada exitosamente');
        }

        function deleteCategory(categoryName) {
            if (confirm(`¿Eliminar la categoría "${categoryName}" y todas sus subcategorías?`)) {
                delete categories[categoryName];
                products.forEach(product => {
                    if (product.category === categoryName) {
                        product.category = '';
                        product.subcategory = '';
                    }
                });
                saveData();
                renderCategories();
                renderCategoryLists();
                renderProducts();
                showToast('Categoría eliminada', 'warning');
            }
        }

        function deleteSubcategory(categoryName, subcategoryName) {
            if (confirm(`¿Eliminar la subcategoría "${subcategoryName}"?`)) {
                categories[categoryName] = categories[categoryName].filter(sub => sub !== subcategoryName);
                products.forEach(product => {
                    if (product.category === categoryName && product.subcategory === subcategoryName) {
                        product.subcategory = '';
                    }
                });
                saveData();
                renderCategories();
                renderCategoryLists();
                renderProducts();
                showToast('Subcategoría eliminada', 'warning');
            }
        }

        // Funciones de productos
        function saveProduct(event) {
            event.preventDefault();
            
            const saveButton = event.target.querySelector('button[type="submit"]');
            const originalText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';
            
            const name = document.getElementById('productName').value.trim();
            const code = document.getElementById('productCode').value.trim();
            const warehouse = document.getElementById('productWarehouse').value;
            const category = document.getElementById('productCategory').value;
            const subcategory = document.getElementById('productSubcategory').value;
            const description = document.getElementById('productDescription').value.trim();
            const imageUrl = document.getElementById('productImageUrl').value.trim();
            
            if (!name || !warehouse || !category) {
                showToast('Nombre, almacén y categoría son obligatorios', 'error');
                saveButton.disabled = false;
                saveButton.textContent = originalText;
                return;
            }
            
            const productId = currentEditId || generateId();
            const existingProductIndex = products.findIndex(p => p.id === productId);
            
            const productData = {
                id: productId,
                name: name,
                code: code,
                warehouse: warehouse,
                category: category,
                subcategory: subcategory,
                description: description,
                image: imageUrl || PLACEHOLDER
            };
            
            if (existingProductIndex !== -1) {
                products[existingProductIndex] = productData;
                showToast('Producto actualizado');
            } else {
                products.push(productData);
                showToast('Producto agregado');
            }
            
            saveData();
            renderProducts();
            renderCatalog();
            clearForm();
            
            saveButton.disabled = false;
            saveButton.textContent = originalText;
        }

        function clearForm() {
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = '<span>Ingresa una URL de imagen</span>';
            document.getElementById('imagePreview').classList.add('empty');
            currentEditId = null;
            loadSubcategories();
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            currentEditId = productId;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCode').value = product.code || '';
            document.getElementById('productWarehouse').value = product.warehouse || '';
            document.getElementById('productCategory').value = product.category;
            loadSubcategories();
            document.getElementById('productSubcategory').value = product.subcategory || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImageUrl').value = product.image && product.image !== PLACEHOLDER ? product.image : '';
            
            if (product.image && product.image !== PLACEHOLDER) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${product.image}" alt="Vista previa">`;
                preview.classList.remove('empty');
            }
            
            showSection('productos');
            document.querySelector('[onclick="showSection(\'productos\')"]').classList.add('active');
            
            showToast('Producto cargado para editar');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function deleteProduct(productId) {
            if (confirm('¿Eliminar este producto?')) {
                products = products.filter(p => p.id !== productId);
                saveData();
                renderProducts();
                renderCatalog();
                showToast('Producto eliminado', 'warning');
            }
        }

        function deleteCurrentProduct() {
            if (currentEditId) {
                deleteProduct(currentEditId);
                clearForm();
            } else {
                showToast('No hay producto seleccionado para eliminar', 'error');
            }
        }

        function renderProducts() {
            const container = document.getElementById('productsList');
            
            if (products.length === 0) {
                container.innerHTML = '<p>No hay productos registrados.</p>';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.image && product.image !== PLACEHOLDER ? 
                            `<img src="${product.image}" alt="${escapeHtml(product.name)}" onerror="this.src='${PLACEHOLDER}'">` : 
                            '<div style="color: #999; font-size: 0.875rem;">Sin imagen</div>'
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-title">${escapeHtml(product.name)}</div>
                        <div class="product-meta">
                            ${product.code ? `Código: ${escapeHtml(product.code)}` : ''}
                        </div>
                        <div class="product-meta">
                            ${escapeHtml(product.warehouse || '')}
                        </div>
                        <div class="product-meta">
                            ${escapeHtml(product.category)}${product.subcategory ? ` / ${escapeHtml(product.subcategory)}` : ''}
                        </div>
                        <div class="product-description">
                            ${escapeHtml(product.description || 'Sin descripción')}
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-outline" onclick="editProduct('${product.id}')">Editar</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        // Funciones del catálogo
        function renderCatalog() {
            const container = document.getElementById('catalogContent');
            
            if (products.length === 0) {
                container.innerHTML = '<p>No hay productos para mostrar en el catálogo.</p>';
                return;
            }
            
            // Agrupar por almacenes, luego por categorías
            const groupedProducts = {};
            products.forEach(product => {
                const warehouse = product.warehouse || 'Sin almacén';
                const category = product.category || 'Sin categoría';
                const subcategory = product.subcategory || 'General';
                
                if (!groupedProducts[warehouse]) {
                    groupedProducts[warehouse] = {};
                }
                if (!groupedProducts[warehouse][category]) {
                    groupedProducts[warehouse][category] = {};
                }
                if (!groupedProducts[warehouse][category][subcategory]) {
                    groupedProducts[warehouse][category][subcategory] = [];
                }
                
                groupedProducts[warehouse][category][subcategory].push(product);
            });
            
            // Renderizar agrupados
            let html = '';
            Object.keys(groupedProducts).forEach(warehouse => {
                html += `<div style="margin-bottom: 2rem;">`;
                html += `<h2 style="color: #1e293b; font-size: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">${escapeHtml(warehouse)}</h2>`;
                
                Object.keys(groupedProducts[warehouse]).forEach(category => {
                    html += `<div style="margin-bottom: 1.5rem;">`;
                    html += `<h3 style="color: #4b5563; font-size: 1.25rem; margin-bottom: 0.75rem;">${escapeHtml(category)}</h3>`;
                    
                    Object.keys(groupedProducts[warehouse][category]).forEach(subcategory => {
                        if (subcategory !== 'General') {
                            html += `<h4 style="color: #6b7280; font-size: 1.1rem; margin: 1rem 0 0.5rem; font-weight: 500;">${escapeHtml(subcategory)}</h4>`;
                        }
                        
                        html += `<div class="products-grid">`;
                        groupedProducts[warehouse][category][subcategory].forEach(product => {
                            html += `
                                <div class="product-card">
                                    <div class="product-image">
                                        ${product.image && product.image !== PLACEHOLDER ? 
                                            `<img src="${product.image}" alt="${escapeHtml(product.name)}" onerror="this.src='${PLACEHOLDER}'">` : 
                                            '<div style="color: #999; font-size: 0.875rem;">Sin imagen</div>'
                                        }
                                    </div>
                                    <div class="product-info">
                                        <div class="product-title">${escapeHtml(product.name)}</div>
                                        <div class="product-meta">
                                            ${product.code ? `Código: ${escapeHtml(product.code)}` : ''}
                                        </div>
                                        <div class="product-description">
                                            ${escapeHtml(product.description || 'Sin descripción')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        // Funciones de importar/exportar
        function exportData() {
            const data = {
                products: products,
                categories: categories,
                warehouses: warehouses,
                config: config,
                exportDate: new Date().toISOString(),
                version: 'v3'
            };
            document.getElementById('exportData').value = JSON.stringify(data, null, 2);
            showToast('Datos exportados - Listo para copiar');
        }

        function importData() {
            const jsonData = document.getElementById('importData').value.trim();
            if (!jsonData) {
                showToast('Pega los datos JSON para importar', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(jsonData);
                
                if (data.products && Array.isArray(data.products)) {
                    products = data.products;
                }
                if (data.categories && typeof data.categories === 'object') {
                    categories = data.categories;
                }
                if (data.warehouses && Array.isArray(data.warehouses)) {
                    warehouses = data.warehouses;
                }
                if (data.config && typeof data.config === 'object') {
                    config = data.config;
                }
                
                saveData();
                
                // Actualizar toda la interfaz
                renderWarehouses();
                renderCategories(); 
                renderProducts();
                renderCatalog();
                renderWarehouseList();
                renderCategoryLists();
                loadConfig();
                
                showToast('Datos importados exitosamente');
                document.getElementById('importData').value = '';
                
            } catch (error) {
                console.error('Error parsing JSON:', error);
                showToast('Error en el formato JSON. Verifica que los datos estén correctos.', 'error');
            }
        }

        function resetAllData() {
            if (confirm('¿Estás seguro de que quieres borrar todos los datos? Esta acción no se puede deshacer.')) {
                products = [];
                categories = {"General": ["Varios"]};
                warehouses = ["Almacén Principal"];
                config = {};
                
                localStorage.removeItem('libomi_products_v3');
                localStorage.removeItem('libomi_categories_v3');
                localStorage.removeItem('libomi_warehouses_v3');
                localStorage.removeItem('libomi_config_v3');
                localStorage.removeItem('libomi_last_sync');
                
                renderWarehouses();
                renderCategories();
                renderProducts();
                renderCatalog();
                clearForm();
                loadConfig();
                updateCloudStatus();
                
                showToast('Todos los datos han sido eliminados', 'warning');
            }
        }

        // Funciones de clipboard
        async function copyToClipboard(elementId) {
            try {
                const text = document.getElementById(elementId).value;
                if (!text) {
                    showToast('No hay datos para copiar', 'warning');
                    return;
                }
                await navigator.clipboard.writeText(text);
                showToast('Datos copiados al portapapeles');
            } catch (err) {
                console.error('Error copying to clipboard:', err);
                showToast('No se pudo copiar. Selecciona el texto manualmente.', 'error');
            }
        }

        async function pasteFromClipboard(elementId) {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById(elementId).value = text;
                showToast('Datos pegados desde el portapapeles');
            } catch (err) {
                console.error('Error pasting from clipboard:', err);
                showToast('No se pudo pegar. Pega manualmente con Ctrl+V.', 'error');
            }
        }
    </script>
</body>
</html>
